{% extends "layouts/base.html" %}

{% block body %}
  <div class='layout'>
    <main>
    <h2>Feed</h2>
      {% for post in posts %}
      <div class="post">
        <h5 class='post-author'>{{ post.author }}</h5>
        <p class='post-body'>{{ post.body }}</p>
        <p class='post-date'>{{ post.date }}</p>
        <div class="counters">
          <span class='likes-count'>{{ post.likes.count }}</span>
          <span class="comments-count">{{ post.comments.count }}</span>
        </div>
        
        <div class="icons">
          <i class="fa-solid fa-heart {% if post.user_liked %}liked{% endif %}" data-slug="{{ post.slug }}"></i>
          <i class="fa-solid fa-comment" data-post-slug="{{ post.slug }}"></i>
          <i class="fa-solid fa-share"></i>
        </div>

         <!--Hidden input for comment-->
          <div id="comment-box-{{ post.slug }}" class="comment-box">
            <input type="text" id="input-{{ post.slug }}" placeholder="Comment here">
            <button class="btn btn-secondary" onclick="addComment('{{post.slug}}')">Comment</button>
          
          
            <div id="comment-list-{{post.slug}}" class="comment-list">
              {% for comment in post.comments.all %}
              <div class="comment">
                <!--Dot notation for related models-->
                <img src="{{ comment.user.profile.profile_picture.url }}">
                <strong>{{ comment.user }}</strong>
                <p class="body">{{ comment.body }}</p>
                <p class="timestamp">{{ comment.created_at|timesince }} ago</p>
              </div>
              {% empty %}
              <p>No comments yet.
              {% endfor %}
            </div>
          </div>


      </div>
      {% endfor %}
    </main>
  </div>

  <script>
      // Function for cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    const hearts = document.querySelectorAll('.fa-solid.fa-heart')

    hearts.forEach(el => {
      el.addEventListener('click', () => {
        const slug = el.dataset.slug;

        const postContainer = el.closest('.post');

        const likesCounter = postContainer.querySelector('.likes-count');

        fetch(`/interactions/post/${slug}/like/`, {
          method: "POST",
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          el.classList.toggle('liked', data.liked);

          likesCounter.textContent = data.likes_count;
        })
        .catch(err => console.error(err));
        });
    });

    const comments = document.querySelectorAll(".fa-solid.fa-comment")

    comments.forEach((comment) => {
      comment.addEventListener('click', (event) => {
        comment.classList.toggle("commenting")

        const postSlug = event.currentTarget.dataset.postSlug;
        const box = document.getElementById(`comment-box-${postSlug}`);

        box.classList.toggle("comment-ready");
      })
    })

    
    function addComment(slug) {
      const input = document.getElementById(`input-${slug}`) 
      const body = input.value.trim()

      if (!body) return;

      fetch(`/interactions/post/${slug}/comment/`, {
        method: "POST",
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ "body": body })
      })
      .then((res) => res.json())
      .then(data => {
        console.log(data);
        input.value = "";
      }) 
      .catch(err => console.error(err.message))
    }




    {% comment %} const like = document.querySelectorAll('.fa-solid.fa-heart')

    like.forEach((el) => {
      el.addEventListener('click', () => {
        el.classList.toggle('liked');
      });
    }); {% endcomment %}

  </script>
{% endblock %}