{% extends "layouts/base.html" %}

{% block body %}
  <div class='layout'>
    <main>
    <h2>Feed</h2>
      {% for post in posts %}
      <div class="post">
        <h5 class='post-author'>{{ post.author }}</h5>
        <p class='post-body'>{{ post.body }}</p>
        <p class='post-date'>{{ post.date }}</p>
        <span class='likes-count'>{{ post.likes.count }}</span>
        
        <div class="icons">
          <i class="fa-solid fa-heart {% if post.user_liked %}liked{% endif %}" data-slug="{{ post.slug }}"></i>
          <i class="fa-solid fa-comment"></i>
          <i class="fa-solid fa-share"></i>
        </div>
      </div>
      {% endfor %}
    </main>
  </div>

  <script>
      // Function for cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    const hearts = document.querySelectorAll('.fa-solid.fa-heart')

    hearts.forEach(el => {
      el.addEventListener('click', () => {
        const slug = el.dataset.slug;

        const postContainer = el.closest('.post');

        const likesCounter = postContainer.querySelector('.likes-count');

        fetch(`/interactions/post/${slug}/like/`, {
          method: "POST",
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          el.classList.toggle('liked', data.liked);

          likesCounter.textContent = data.likes_count;
        })
        .catch(err => console.error(err));
        });
    });




    {% comment %} const like = document.querySelectorAll('.fa-solid.fa-heart')

    like.forEach((el) => {
      el.addEventListener('click', () => {
        el.classList.toggle('liked');
      });
    }); {% endcomment %}

    const comment = document
  </script>
{% endblock %}